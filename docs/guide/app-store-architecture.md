# 架构与安全

## 后端服务架构

为了保证高可用性和扩展性，应用商店后端采用微服务架构思想（视规模可逐步拆分）。

### 核心服务
1.  **应用元数据服务 (App Metadata Service)**
    *   管理应用的标题、描述、图标、分类等静态信息。
    *   提供应用列表和详情的查询接口（支持高并发读取）。
2.  **安装包分发服务 (Distribution Service)**
    *   集成对象存储（OSS/COS）存储应用包。
    *   配合 CDN 全球加速，确保各地商户都能高速下载。
    *   支持增量更新（Diff），减少带宽消耗。
3.  **支付与结算服务 (Payment & Billing)**
    *   处理应用购买订单。
    *   计算平台抽成与开发者收入。
    *   管理订阅周期和续费逻辑。
4.  **许可证验证服务 (License Service)**
    *   生成和验证应用授权码（License Key）。
    *   防止应用被非法复制和分发（DRM 机制）。

### API 设计
*   **协议**：RESTful API 为主，复杂查询可引入 GraphQL。
*   **文档**：提供完善的 Swagger/OpenAPI 文档。
*   **限流**：针对 API 调用进行速率限制（Rate Limiting），防止滥用。

## 应用安装与运行环境

### 安全沙箱 (Sandbox)
为了防止恶意插件破坏主系统，我们引入安全沙箱机制：

1.  **文件系统隔离**：
    *   应用只能读写其专属目录（`plugins/{app_id}/`）。
    *   严禁修改核心框架文件或其他应用的文件。
2.  **数据库隔离**：
    *   应用表必须添加特定前缀（如 `plugin_{app_id}_`）。
    *   限制对核心用户表、订单表的直接写操作（需通过 API 调用）。
3.  **API 审计**：
    *   所有外部 HTTP 请求需经过代理或白名单验证。
    *   记录应用调用的敏感操作日志。

### 安装机制
1.  **依赖检测**：安装前自动检查 PHP 扩展、Laravel 版本及其他插件依赖。
2.  **版本冲突处理**：如果检测到文件冲突或类名冲突，自动终止安装并提示。
3.  **事务性安装**：文件解压、数据库迁移等操作在事务中进行，失败自动回滚，确保系统不被破坏。
4.  **一键卸载**：完全清理应用文件和数据库表，不留残留。

## 安全策略

1.  **代码安全**
    *   **静态分析**：使用 SonarQube 等工具扫描代码质量和漏洞。
    *   **人工审计**：对涉及支付、用户数据的应用进行重点人工审查。
2.  **数据隐私**
    *   商户数据与应用开发者完全隔离。
    *   应用获取敏感权限（如导出订单）时，必须获得商户显式授权。
3.  **支付安全**
    *   交易二次确认机制。
    *   完善的退款流程和争议解决机制。
